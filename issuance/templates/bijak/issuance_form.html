{% extends 'base.html' %}
{% block content %}
    {% load static %}
    <!DOCTYPE html>
    <html lang="fa" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>فرم صدور بارنامه</title>
        <link rel="stylesheet"
              href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap">
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
        <link rel="stylesheet" href="{% static 'style.css' %}">
        <link rel="stylesheet" href="{% static 'css/form.css' %}">

        <style>
            .selectable-card {
                cursor: pointer;
                border: 1px solid #ddd;
                transition: 0.2s;
                position: relative;
            }

            .selectable-card:hover {
                background-color: #f8f9fa;
            }

            .selectable-card.selected {
                border-color: #28a745;
                background-color: #e6f4ea;
            }

            .selectable-card .checkmark {
                display: none;
                color: green;
                font-size: 1.2rem;
            }

            .selectable-card.selected .checkmark {
                display: inline;
            }
        </style>

    </head>
    <body>
    <form method="post" action="{% url 'create_new' %}" id="bijakForm">
        <div class="container">
            <h2>فرم ثبت بارنامه جدید</h2>

            <!-- بخش نمایش پیام ها  -->
            <hr>
            {% if messages %}
                <div class="mt-3">
                    {% for message in messages %}
                        <div class="alert
                  {% if message.tags == 'error' %}alert-danger
                  {% elif message.tags == 'success' %}alert-success
                  {% else %}alert-info{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            <hr>
            {% csrf_token %}
            <!-- بخش فرستنده و گیرنده  -->
            <div class="row">
                <div class="col-md-6">
                    <div class="section">
                        <h3>انتخاب فرستنده</h3>
                        <hr>
                        <div class="row">
                            <div class="text-center col-md-10">
                                <input type="text" id="sender-input" class="form-control"
                                       placeholder="جستجوی فرستنده...">
                                <input type="hidden" id="sender-id" name="sender">
                                <div id="sender-results" class="list-group"></div>
                            </div>
                            <div class="text-center col-md-1">
                                <a href="{% url 'add_customer' %}" target="_self"
                                   class="btn btn-secondary btn-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                         fill="currentColor"
                                         class="bi bi-plus" viewBox="0 0 16 16">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <div class="col-md-6">
                    <div class="section">
                        <h3>انتخاب گیرنده</h3>
                        <hr>
                        <div class="row">
                            <div class="text-center col-md-10">
                                <input type="text" id="receiver-input" class="form-control"
                                       placeholder="جستجوی گیرنده...">
                                <input type="hidden" id="receiver-id" name="receiver">  <!-- مقدار واقعی -->
                                <div id="receiver-results" class="list-group"></div>
                            </div>
                            <div class="text-center col-md-1">
                                <a href="{% url 'add_customer' %}" target="_self"
                                   class="btn btn-secondary btn-lg btn-block">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                         fill="currentColor"
                                         class="bi bi-plus" viewBox="0 0 16 16">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- بخش راننده و خودرو  -->
            <div class="row">
                <div class="col-md-6">
                    <div class="section">
                        <hr>
                        <h3>اطلاعات راننده</h3>
                        <hr>
                        <div class="row">
                            <div class="text-center col-md-10">
                                <input type="text" id="driver-input" class="form-control"
                                       placeholder="جستجوی راننده...">
                                <input type="hidden" id="driver-id" name="driver">
                                <input type="hidden" id="vehicle-plate" name="vehicle_plate"> <!-- شماره پلاک -->
                                <div id="driver-results" class="list-group"></div>
                            </div>
                            <div class="text-center col-md-1">
                                <a href="{% url 'add_driver' %}" target="_self"
                                   class="btn btn-secondary btn-lg btn-block">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                         fill="currentColor"
                                         class="bi bi-plus" viewBox="0 0 16 16">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <div class="col-md-6">
                    <div class="section">
                        <hr>
                        <h3>اطلاعات خودروی راننده</h3>
                        <hr>
                        <div class="row">
                            <div class="text-center col-md-10">
                                <div class="plate">
                                    <!-- استان -->
                                    <div class="province">
                                        <span>ایران</span>
                                        <span id="province">{{ vehicle.license_plate_series }}</span>
                                    </div>

                                    <!-- اعداد و حرف پلاک -->
                                    <div class="number-box">
                                        <span id="second-number">{{ vehicle.license_plate_three_digit }}</span>
                                        <span class="letter" id="letter">{{ vehicle.license_plate_alphabet }}</span>
                                        <span id="first-number">{{ vehicle.license_plate_two_digit }}</span>
                                    </div>

                                    <!-- پرچم ایران -->
                                    <div class="flag-box">
                                        {#                                        <img src="https://upload.wikimedia.org/wikipedia/commons/c/ca/Flag_of_Iran.svg"#}
                                        {#                                             alt="Iran Flag">#}
                                        {#                                        <link type="image/png" sizes="96x96" rel="icon" href=".../icons8-iran-clouds-96.png">#}
                                        <img src="{% static 'images/icons8-iran-100.png' %}">
                                        <span>I.R. IRAN</span>
                                    </div>

                                    <!-- hidden برای ذخیره در دیتابیس -->
                                    <input type="hidden" id="vehicle-id" name="vehicle">
                                </div>
                            </div>
                            <div class="text-center col-md-1">
                                <a href="{% url 'add_vehicle' %}" target="_self"
                                   class="btn btn-secondary btn-lg btn-block">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                         fill="currentColor"
                                         class="bi bi-plus" viewBox="0 0 16 16">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- بخش بارنامه و محموله  -->
            <div class="row">
                <div class="col-md-6">
                    <div class="section">
                        <hr>
                        <h3>اطلاعات بارنامه</h3>
                        <hr>
                        {{ shipment_form.as_p }}
                    </div>
                </div>
                <br>
                <div class="col-md-6">
                    <div class="section">
                        <hr>
                        <h3>اطلاعات محموله</h3>
                        <hr>
                        {{ cargo_form.as_p }}
                    </div>
                </div>
            </div>

            <!-- بخش افزودن توضیحات -->
            <div class="row">
                <div class="col-md-12">
                    <div class="section">
                        <h3>توضیحات</h3>
                        <hr>

                        <!-- ✅ توضیح پیش‌فرض -->
                        <div class="alert alert-info text-center mb-3">
                            <strong>توضیح پیش‌فرض:</strong>
                            <span>حمل بار طبق مقررات و مسئولیت راننده انجام می‌شود.</span>
                        </div>

                        <div class="row">
                            <div class="col-md-12">

                                <!-- ✅ انتخاب یک توضیح از لیست -->
                                <div class="form-field section">
                                    <label for="caption-select" class="fw-bold mb-2">انتخاب توضیح آماده
                                        (اختیاری)</label>
                                    <select id="caption-select"
                                            name="selected_caption"
                                            class="form-select">
                                        <option value="">-- انتخاب کنید --</option>
                                        {% for caption in captions %}
                                            <option value="{{ caption.id }}">{{ caption.content|truncatechars:100 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- ✅ توضیح دستی -->
                                <div class="mt-3">
                                    <label for="customExplanation" class="form-label fw-bold">توضیح دستی
                                        (اختیاری)</label>
                                    <textarea id="customExplanation"
                                              name="manual_description"
                                              rows="3"
                                              class="form-control"
                                              placeholder="اگر توضیح خاصی دارید، اینجا بنویسید..."></textarea>
                                </div>
                            </div>

                            <!-- ✅ لینک افزودن توضیح دائمی -->
                            <div class="text-center mt-4">
                                <a href="{% url 'add_caption' %}" class="btn btn-secondary btn-lg">
                                    افزودن توضیح همیشگی
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <hr>
            <div style="text-align: center;">
                {% if bijak.pk %}
                    <button type="submit" name="action" value="save_print" class="btn btn-success"
                            rel={% url 'preview' bijak.pk %}>
                        ثبت و چاپ
                    </button>
                {% else %}
                    <button class="btn btn-secondary" disabled>پیش‌نمایش</button>
                {% endif %}


                <button type="submit" name="action" value="save" class="btn btn-success">ثبت</button>
                <button type="submit" name="action" value="print" class="btn btn-primary">ثبت و چاپ</button>


                {#        <button type="submit" name="action" value="draft" class="btn btn-secondary">#}
                {#            ثبت موقت قبل از چاپ#}
                {#        </button>#}
                <button type="submit" name="action" class="print-button" rel="{% url 'create_new' %}">
                    صفحه اصلی
                </button>
            </div>
            <hr>
            <br>
        </div>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.0.6/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <script>
        const urls = {
            searchCustomer: "{% url 'search_customer' %}",
            searchDriver: "{% url 'search_driver' %}",
            getVehicleByDriver: "{% url 'get_vehicle_by_driver' %}",
            searchVehicle: "{% url 'search_vehicle' %}"
        };
    </script>

    <script src="{% static 'shipment_form.js' %}">

    </script>


    </body>
    </html>
{% endblock %}
