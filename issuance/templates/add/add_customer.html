<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ویرایش اطلاعات مشتری</title>
    <style>
        body {
            font-family: sans-serif;
            direction: rtl;
            margin: 50px;
        }

        .form-box {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h3>ویرایش / ثبت مشتری</h3>

<form id="customer-form">
    <input type="hidden" id="customer-id" name="id">

    <div class="mb-3">
        <label>نام مشتری:</label>
        <input type="text" id="customer-input" name="name" class="form-control">
        <div id="customer-results" class="list-group"
             style="display:none; z-index:1000; width:100%;"></div>
    </div>

    <div class="mb-3">
        <label>شناسه/کد ملی:</label>
        <input type="text" id="customer-national" name="national" class="form-control">
    </div>

    <div class="mb-3">
        <label>کد پستی:</label>
        <input type="text" id="customer-postal" name="postal" class="form-control">
    </div>

    <div class="mb-3">
        <label>تلفن:</label>
        <input type="text" id="customer-phone" name="phone" class="form-control">
    </div>

    <div class="mb-3">
        <label>آدرس:</label>
        <input type="text" id="customer-address" name="address" class="form-control">
    </div>

    <button type="submit" class="btn btn-success">ذخیره</button>
    <button type="button" id="add-to-customer" class="btn btn-warning">
        افزودن اطلاعات به همین مشتری
    </button>
</form>

<p id="msg"></p>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let selectedIndex = -1;

        // جستجو
        $("#customer-input").on("keyup", function (e) {
            let query = $(this).val().trim();

            // اگر خالی شد → همه فیلدها رو پاک کن
            if (query.length === 0) {
                clearForm("");
                $("#customer-results").empty().hide();
                selectedIndex = -1;
                return;
            }

            // کنترل کلیدها
            if (e.keyCode === 38) {
                if (selectedIndex > 0) selectedIndex--;
                highlightItem();
                return;
            }
            if (e.keyCode === 40) {
                if (selectedIndex < $("#customer-results .list-group-item").length - 1) selectedIndex++;
                highlightItem();
                return;
            }
            if (e.keyCode === 13) {
                e.preventDefault();
                let selected = $("#customer-results .list-group-item").eq(selectedIndex);
                if (selected.length) {
                    chooseItem(selected);
                }
                return;
            }

            $.ajax({
                url: "{% url 'search_customer' %}",
                data: {q: query},
                success: function (data) {
                    let html = "";
                    if (data.results.length > 0) {
                        data.results.forEach(function (item) {
                            html += `<button type="button"
                                    class="list-group-item list-group-item-action"
                                    data-id="${item.id}"
                                    data-name="${item.name}"
                                    data-national="${item.national_id || ''}"
                                    data-postal="${item.postal || ''}"
                                    data-phone="${item.phone || ''}"
                                    data-address="${item.address || ''}">
                                    <strong>${item.name}</strong>
                                    ${item.phone ? " -{" + item.address + "}": "📂"}
                                 </button>`;
                        });
                    } else {
                        clearForm(query); // نتیجه‌ای نبود → فرم خالی شه و فقط نام بمونه
                        html = `<div class="list-group-item">نتیجه‌ای یافت نشد</div>`;
                    }
                    $("#customer-results").html(html).show();
                    selectedIndex = -1;
                }
            });
        });

        function highlightItem() {
            $("#customer-results .list-group-item").removeClass("active");
            if (selectedIndex >= 0) {
                $("#customer-results .list-group-item").eq(selectedIndex).addClass("active");
            }
        }

        function chooseItem(item) {
            $("#customer-id").val(item.data("id"));
            $("#customer-input").val(item.data("name"));
            $("#customer-national").val(item.data("national"));
            $("#customer-postal").val(item.data("postal"));
            $("#customer-phone").val(item.data("phone"));
            $("#customer-address").val(item.data("address"));
            $("#customer-results").empty().hide();
        }

        // فرم خالی‌ساز
        function clearForm(name = "") {
            $("#customer-id").val("");
            $("#customer-input").val(name);
            $("#customer-national").val("");
            $("#customer-postal").val("");
            $("#customer-phone").val("");
            $("#customer-address").val("");
        }

        // انتخاب با کلیک
        $(document).on("click", "#customer-results .list-group-item", function () {
            chooseItem($(this));
        });

        // ذخیره اطلاعات
        $("#customer-form").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: "{% url 'save_customer' %}",
                type: "POST",
                data: $(this).serialize(),
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                success: function (resp) {
                    if (resp.success) {
                        $("#msg").text("با موفقیت ذخیره شد (ID: " + resp.id + ")");
                    } else {
                        $("#msg").text("خطا: " + resp.error);
                    }
                },
                error: function () {
                    $("#msg").text("مشکلی در ارتباط با سرور پیش آمد");
                }
            });
        });

        // افزودن اطلاعات به همین مشتری (ایجاد رکورد جدید)
        $("#add-to-customer").click(function () {
            let customerId = $("#customer-id").val();

            if (!customerId) {
                $("#msg").text("ابتدا یک مشتری را انتخاب کنید.");
                return;
            }

            $.ajax({
                url: "{% url 'duplicate_customer' %}",   // ویوی جدید در جنگو
                type: "POST",
                data: $("#customer-form").serialize(),   // تمام فیلدهای فرم
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                success: function (resp) {
                    if (resp.success) {
                        $("#msg").text("رکورد جدید برای مشتری ایجاد شد (ID: " + resp.new_id + ")");
                        $("#customer-id").val(resp.new_id);  // می‌تونی انتخاب کنی روی رکورد جدید بمونه
                    } else {
                        $("#msg").text("خطا: " + resp.error);
                    }
                },
                error: function () {
                    $("#msg").text("مشکلی در ارتباط با سرور پیش آمد");
                }
            });
        });
    });
</script>


</body>
</html>