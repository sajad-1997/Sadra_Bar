{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ</title>
    <style>
        body {
            font-family: sans-serif;
            direction: rtl;
            margin: 50px;
        }

        .form-box {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h3>ÙˆÛŒØ±Ø§ÛŒØ´ / Ø«Ø¨Øª Ù…Ø´ØªØ±ÛŒ</h3>

<form id="customer-form">
    <input type="hidden" id="customer-id" name="id">

    <div class="mb-3">
        <label>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ:</label>
        <input type="text" id="customer-input" name="name" class="form-control">
        <div id="customer-results" class="list-group"
             style="display:none; z-index:1000; width:100%;"></div>
    </div>

    <div class="mb-3">
        <label>Ø´Ù†Ø§Ø³Ù‡/Ú©Ø¯ Ù…Ù„ÛŒ:</label>
        <input type="text" id="customer-national" name="national" class="form-control">
    </div>

    <div class="mb-3">
        <label>Ú©Ø¯ Ù¾Ø³ØªÛŒ:</label>
        <input type="text" id="customer-postal" name="postal" class="form-control">
    </div>

    <div class="mb-3">
        <label>ØªÙ„ÙÙ†:</label>
        <input type="text" id="customer-phone" name="phone" class="form-control">
    </div>

    <div class="mb-3">
        <label>Ø¢Ø¯Ø±Ø³:</label>
        <input type="text" id="customer-address" name="address" class="form-control">
    </div>

    <button type="submit" class="btn btn-success">Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</button>
    <button type="button" id="add-to-customer" class="btn btn-warning">
        Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ ÙØ¹Ù„ÛŒ
    </button>
</form>

<p id="msg"></p>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let selectedIndex = -1;

        // Ø¬Ø³ØªØ¬Ùˆ
        $("#customer-input").on("keyup", function (e) {
            let query = $(this).val();  // ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ Ø­ÙØ¸ Ø´ÙˆÙ†Ø¯

            // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø®Ø§Ù„ÛŒ Ø´Ø¯ â†’ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯
            if (query.length === 0) {
                clearForm();
                $("#customer-results").empty().hide();
                selectedIndex = -1;
                return;
            }

            // Ú©Ù†ØªØ±Ù„ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ†/Enter
            if (e.keyCode === 38) {  // Ø¨Ø§Ù„Ø§
                if (selectedIndex > 0) selectedIndex--;
                highlightItem();
                return;
            }
            if (e.keyCode === 40) {  // Ù¾Ø§ÛŒÛŒÙ†
                if (selectedIndex < $("#customer-results .list-group-item").length - 1) selectedIndex++;
                highlightItem();
                return;
            }
            if (e.keyCode === 13) {  // Enter
                e.preventDefault();
                let selected = $("#customer-results .list-group-item").eq(selectedIndex);
                if (selected.length) {
                    chooseItem(selected);
                }
                return;
            }

            // AJAX Ø¬Ø³ØªØ¬Ùˆ
            $.ajax({
                url: "{% url 'search_customer' %}",
                data: {q: query},
                success: function (data) {
                    let html = "";
                    if (data.results.length > 0) {
                        data.results.forEach(function (item) {
                            html += `<button type="button"
                                    class="list-group-item list-group-item-action"
                                    data-id="${item.id}"
                                    data-name="${item.name}"
                                    data-national="${item.national_id || ''}"
                                    data-postal="${item.postal || ''}"
                                    data-phone="${item.phone || ''}"
                                    data-address="${item.address || ''}">
                                    <strong>${item.name}</strong>
                                    ${item.phone ? " -{" + item.address + "}": "ğŸ“‚"}
                                 </button>`;
                        });
                    } else {
                        // âŒ Ù†ØªÛŒØ¬Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ â†’ ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ù†ØªØ§ÛŒØ¬ØŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù¾Ø§Ú© Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
                        html = `<div class="list-group-item">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>`;
                    }
                    $("#customer-results").html(html).show();
                    selectedIndex = -1;
                }
            });
        });

        function highlightItem() {
            $("#customer-results .list-group-item").removeClass("active");
            if (selectedIndex >= 0) {
                $("#customer-results .list-group-item").eq(selectedIndex).addClass("active");
            }
        }

        function chooseItem(item) {
            $("#customer-id").val(item.data("id"));
            $("#customer-input").val(item.data("name"));
            $("#customer-national").val(item.data("national"));
            $("#customer-postal").val(item.data("postal"));
            $("#customer-phone").val(item.data("phone"));
            $("#customer-address").val(item.data("address"));
            $("#customer-results").empty().hide();
        }

        // ÙØ±Ù… Ø®Ø§Ù„ÛŒâ€ŒØ³Ø§Ø²: ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ Ø±Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        function clearForm() {
            $("#customer-id").val("");
            $("#customer-input").val("");
            $("#customer-national").val("");
            $("#customer-postal").val("");
            $("#customer-phone").val("");
            $("#customer-address").val("");
        }

        // Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§ Ú©Ù„ÛŒÚ©
        $(document).on("click", "#customer-results .list-group-item", function () {
            chooseItem($(this));
        });

        // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        $("#customer-form").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: "{% url 'save_customer' %}",
                type: "POST",
                data: $(this).serialize(),
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                success: function (resp) {
                    if (resp.success) {
                        $("#msg").text("Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (ID: " + resp.id + ")");
                    } else {
                        $("#msg").text("Ø®Ø·Ø§: " + resp.error);
                    }
                },
                error: function () {
                    $("#msg").text("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù¾ÛŒØ´ Ø¢Ù…Ø¯");
                }
            });
        });

        // Ø§ÙØ²ÙˆØ¯Ù† Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ
        $("#add-to-customer").click(function () {
            let customerId = $("#customer-id").val();

            if (!customerId) {
                $("#msg").text("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù…Ø´ØªØ±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
                return;
            }

            $.ajax({
                url: "{% url 'duplicate_customer' %}",
                type: "POST",
                data: $("#customer-form").serialize(),
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                success: function (resp) {
                    if (resp.success) {
                        $("#msg").text("Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ (ID: " + resp.new_id + ")");
                        $("#customer-id").val(resp.new_id);
                    } else {
                        $("#msg").text("Ø®Ø·Ø§: " + resp.error);
                    }
                },
                error: function () {
                    $("#msg").text("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù¾ÛŒØ´ Ø¢Ù…Ø¯");
                }
            });
        });
    });
</script>



</body>
</html>